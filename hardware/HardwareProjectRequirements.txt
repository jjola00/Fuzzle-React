AI Study Buddy â€“ Hardware & Software Requirements
=================================================

0. Purpose
----------
Create a desktop â€œstudyâ€‘buddyâ€ robot that:  
â€¢ Detects that the student is present and alert (PIR + camera eyeâ€‘tracking).  
â€¢ Listens & speaks to answer questions through an onâ€‘board AI assistant (wakeâ€‘word + STT + TTS).  
â€¢ Moves small servos to animate eyes / tail when it talks or when attention drops.  
â€¢ Shows a Pomodoro timer & basic status on a small display.  

Everything below is phrased so that an engineer can start coding immediately.

1. Bill of Materials
--------------------
| # | Part | Interface | Notes |
|---|------|-----------|-------|
| 1 | Raspberryâ€¯Pi 4â€¯Modelâ€¯B, 4â€¯GB+ | â€” | Main SBC |
| 2 | HCâ€‘SR501 PIR motion sensor | 1Â Ã—Â GPIO (digital) | 5Â V tolerant |
| 3 | Pi Cameraâ€¯2 (CSIâ€‘2 ribbon) | CSI port | 1080p30 minimum |
| 4 | Servo driverÂ â€“ Adafruit PCA9685 16â€‘Ch | IÂ²C @0x40 | Generates 50â€¯Hz PWM |
| 5 | Micro 5â€“6â€¯V hobby servos Ã—â€¯N (eyes, tailâ€¦) | PWM (from #4) | Max currentÂ â‰ˆÂ 500â€¯mAÂ each |
| 6 | â€œMakerâ€‘HATâ€ Audio board (MAX98357A codec or similar) | IÂ²S + IÂ²C | Stereo out + mono mic in |
| 7 | IÂ²C 0.96â€³ SSD1306 OLED (128Ã—64) or IÂ²C 1602 LCD | IÂ²C | Display timer |
| 8 | Momentary pushâ€‘button (user) | 1Â Ã—Â GPIO | Mapped to GPIO17 |
| 9 | 5â€¯V /â€¯3â€¯A regulated supply for Pi | â€” | USBâ€‘C |
|10 | 5â€¯V /â€¯3â€¯A supply for servos | â€” | **Ground must be common with Pi** |

2. Raspberryâ€¯Pi 40â€‘Pin Header Map
---------------------------------
All pin numbers are **physical**. BCM column is what code must use.

| Function/Part        | BCM | Pin | Voltage | Direction |
|----------------------|-----|-----|---------|-----------|
| **Global rails**     | â€”   |  1  | 3.3â€¯V |Â â€” |
|                      | â€”   |  2  | 5â€¯V   |Â â€” |
|                      | â€”   |  4  | 5â€¯V   |Â â€” |
|                      | â€”   |  6  | GND   |Â â€” |
| **IÂ²C bus (shared)** | SDA1 | 2 | 3  | Biâ€‘dir |
| (AudioÂ HATÂ ctrl +    | SCL1 | 3 | 5  | Biâ€‘dir |
|  Servo driver + OLED)|     |     |    |       |
| **Audio HAT â€“ IÂ²S**  | GPIO18 (BCLK) | 12 | 3.3â€¯V | OUT |
|                      | GPIO19 (LRCLK)| 35 | 3.3â€¯V | OUT |
|                      | GPIO21 (DACÂ OUT) | 40 | 3.3â€¯V | OUTâ€‘toâ€‘speaker |
|                      | GPIO20 (ADCÂ IN)  | 38 | 3.3â€¯V | INâ€‘fromâ€‘mic |
| **Audio HAT button** | GPIO17 | 11 | 3.3â€¯V | IN (pullâ€‘up) |
| **PIR sensor**       | GPIO23 | 16 | 3.3â€¯V | IN (activeâ€‘high) |
|                      | VCCÂ â†’Â PinÂ 2 (5â€¯V) | â€” | 5â€¯V | â€” |
|                      | GNDÂ â†’Â PinÂ 14/6   | â€” | GND | â€” |
| **Servo driver PCA9685** | VCCÂ 3.3Â VÂ â†’Â PinÂ 1 | â€” | 3.3â€¯V | â€” |
|                      | SDA/SCL shared (see IÂ²C) | â€” | â€” | â€” |
|                      | GNDÂ â†’Â PinÂ 6 | â€” | GND | â€” |
|                      | V+ (5â€“6â€¯V) from ext. PSU | â€” | 5â€¯V | â€” |
| **OLED/LCD Display** | Uses same IÂ²C bus; no extra pins |

_Unused GPIOs (4, 5, 6, 12, 13, 22, 24, 26) are free for future features._

3. Electrical Limits & Safety
-----------------------------
* Total Pi 3.3â€¯V rail budget must stay <â€¯800â€¯mA.  
* **Servos NEVER powered from Pi** â€“ they draw bursts >â€¯500â€¯mA. Power PCA9685 V+ from external 5â€“6â€¯V rail and connect grounds.  
* Keep IÂ²C lines under 30â€¯cm; use 4.7â€¯kÎ© pullâ€‘ups if your breakouts lack them.  
* PIR sensor is 5â€¯V but output is 3.3â€¯V logicâ€‘safe. Confirm jumper is set to Hâ€‘L (not Hâ€‘H).  

4. Software Stack
-----------------
* **OS**â€ƒRaspberryÂ PiÂ OSÂ BookwormÂ (64â€‘bit)  
* **Language**â€ƒPythonÂ 3.11  
* **Packages**  
  - `gpiozero` 2.0+ (simple GPIO)  
  - `pigpio` daemon (precise PWM fallback)  
  - `smbus2`, `adafruit-pca9685` (servo driver)  
  - `picamera2`, `opencv-python`, `mediapipe` (eye tracking)  
  - `sounddevice` + `wavio` or `pyalsaaudio` (IÂ²S access)  
  - `speechrecognition`, `openai` (STT+LLM)  
  - `pyttsx3` or `coqui-tts` (offline TTS)  
  - `rich` (CLI UI)  
* **Runtime services**  
  - `pigpiod` autostart.  
  - Enable IÂ²C and IÂ²S overlays in `/boot/config.txt`  
    ```
    dtparam=i2c_arm=on
    dtoverlay=i2s-mmap
    dtoverlay=hifiberry-dac
    ```  
  - Camera enabled via `libcamera`.

5. Functional Requirements & Thresholds
---------------------------------------
### 5.1 Motion Detection
* Poll PIR **GPIO23** with edge interrupts.  
* Debounce: ignore triggers shorter than **100â€¯ms**.  
* If no motion for **15â€¯min** â€‘â€‘> standby (dim display, mute mics).  

### 5.2 Eyeâ€‘Presence Monitoring
* Capture 640Ã—480 @â€¯15â€¯fps.  
* Use MediaPipe iris model.  
* If eyes not detected **â‰¥â€¯3â€¯s** raise `DROWSY` event â†’  
  - Say â€œStay focused!â€  
  - Wiggle servos (#4) tail left/right 2â€¯Ã—.  

### 5.3 Conversational AI
* Wakeâ€‘word â€œStudy Buddyâ€ (Porcupine).  
* After wake, record until **500â€¯ms** of silence.  
* Transcribe via OpenAI Whisper.  
* Pass text to GPTâ€‘4o with predefined system prompt â€œYou are an encouraging tutorâ€.  
* TTS reply via `coqui-tts`, playback to DAC.  
* During speech playback, flash eye servos at **Â±15Â°** around neutral.

### 5.4 Servo Animation
* Channel map (PCA9685):  
  | Channel | Part | Minâ€¯us | Maxâ€¯us | Neutral | Comment |
  |---------|------|--------|--------|---------|---------|
  | 0 | Left eye | 500 | 2500 | 1500 | look centre |
  | 1 | Right eye| â€¦ | â€¦ | â€¦ | |
  | 2 | Tail     | 600 | 2400 | 1500 | swish |

* Update at 50â€¯Hz.  
* Absolute travel limited 0â€“180â€¯Â°.  

### 5.5 Display
* Show 25â€¯min Pomodoro countdown once motion or wakeâ€‘word detected.  
* LineÂ 1: â€œFocus:Â MM:SSâ€ counting down.  
* LineÂ 2: status icons: ğŸ“¶ (Wiâ€‘Fi), ğŸ”Š (mute state), ğŸ™‚ / ğŸ˜´.  
* When timer hits 00:00 play short chime, set break 5â€¯min.  

6. Software Architecture (highâ€‘level)
-------------------------------------
```
main.py
 â”œâ”€ core/
 â”‚   â”œâ”€ sensors.py      # PIR + camera
 â”‚   â”œâ”€ audio_io.py     # I2S streams
 â”‚   â”œâ”€ servo_ctrl.py   # PCA9685 wrapper
 â”‚   â”œâ”€ display.py      # OLED/LCD
 â”‚   â”œâ”€ ai_agent.py     # STT, GPT, TTS
 â”‚   â””â”€ events.py       # pubâ€‘sub event bus
 â””â”€ app.py              # state machine (IDLE, FOCUS, BREAK, SLEEP)
```

7. Build & Test Checklist
-------------------------
1. **Smokeâ€‘test power rails**: Pi <â€¯700â€¯mA idle; servos on ext. supply.  
2. `i2cdetect -y 1` shows addresses 0x40 (PCA9685) + 0x3C (OLED) + 0x1A (Audio HAT).  
3. Play sineâ€‘wave WAV â†’ speakers; record mic loopâ€‘back, SNR >â€¯60â€¯dB.  
4. Eye detection unitâ€‘test: â‰¥Â 95â€¯% positive detection over 100Â frames.  
5. Full Pomodoro cycle without crash â‰¥Â 3Â h soakâ€‘test.  

8. Known Conflicts & Resolutions
--------------------------------
* IÂ²C is **shared** by three devices; keep total bus capacitance <â€¯400â€¯pF.  
* GPIO18 is used by IÂ²S, cannot be used for PWM. Servo driver offloads PWM anyway.  
* Only one camera can be attached to CSI port.  

9. Deliverables
---------------
* Complete Python project repo.  
* `requirements.txt` for pip.  
* `systemd` service file `studybuddy.service` (Bootâ€‘atâ€‘start).  
* Calibration script `calibrate_servos.py`.

EOF
